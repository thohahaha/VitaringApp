<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" fill="clear">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Detail Post</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="post-detail-container">
    
    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
      <ion-spinner name="crescent"></ion-spinner>
      <ion-text>
        <p>Memuat detail post...</p>
      </ion-text>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="loadingError && !isLoading">
      <div class="error-content">
        <ion-icon name="alert-circle" class="error-icon"></ion-icon>
        <h3>Terjadi Kesalahan</h3>
        <p>{{ loadingError }}</p>
        <ion-button (click)="loadPostFromFirestore()">
          Coba Lagi
        </ion-button>
      </div>
    </div>

    <!-- Main Content - Only show when post is loaded -->
    <div *ngIf="currentPost && !isLoading">
    
      <!-- Main Post Card -->
      <div class="main-post-card">
        <div class="post-header">
          <div class="author-info">
            <div class="author-avatar-container">
              <ion-icon name="person-circle" class="author-avatar-icon"></ion-icon>
            </div>
            <div class="author-details">
              <div class="author-name">{{ currentPost.author }}</div>
              <div class="post-date">{{ currentPost.createdAt | date:'short' }}</div>
            </div>
          </div>
        </div>

        <div class="post-content">
          <h2 class="post-title">{{ currentPost.title }}</h2>
          <div class="post-body">
            <p>{{ currentPost.content }}</p>
          </div>
        </div>

        <div class="post-stats">
          <div class="stat-item likes" [class.liked]="currentPost.userLiked">
            <ion-icon name="heart"></ion-icon>
            <span>{{ currentPost.likesCount }} suka</span>
          </div>
          <div class="stat-item">
            <ion-icon name="chatbubble-outline"></ion-icon>
            <span>{{ comments.length }} komentar</span>
          </div>
          <div class="stat-item">
            <ion-icon name="share-outline"></ion-icon>
            <span>{{ currentPost.shareCount || 0 }} share</span>
          </div>
          <div class="stat-item">
            <ion-icon name="eye-outline"></ion-icon>
            <span>{{ currentPost.viewsCount || 0 }} views</span>
          </div>
        </div>

        <div class="action-buttons">
          <ion-button 
            fill="outline" 
            class="like-button"
            [class.liked]="currentPost.userLiked"
            (click)="toggleLike()">
            <ion-icon name="heart" slot="start"></ion-icon>
            {{ currentPost.userLiked ? 'Disukai' : 'Suka' }}
          </ion-button>
          
          <ion-button 
            fill="outline" 
            class="share-button"
            (click)="sharePost()">
            <ion-icon name="share-outline" slot="start"></ion-icon>
            Bagikan
          </ion-button>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="comments-section">
        <div class="comments-header">
          <h3 class="comments-title">
            <ion-icon name="chatbubble-outline"></ion-icon>
            Komentar ({{ comments.length }})
          </h3>
          <!-- Test button untuk memuat dummy comments (bisa dihapus di production) -->
          <ion-button 
            size="small" 
            fill="outline" 
            color="warning"
            (click)="loadDummyComments()"
            *ngIf="comments.length === 0">
            Load Test Comments
          </ion-button>
        </div>

        <!-- Comments Loading State -->
        <div class="loading-container" *ngIf="isLoadingComments">
          <ion-spinner name="dots"></ion-spinner>
          <ion-text>
            <p>Memuat komentar...</p>
          </ion-text>
        </div>

        <!-- Comments Error State -->
        <div class="error-container" *ngIf="commentsError && !isLoadingComments">
          <div class="error-content">
            <ion-icon name="chatbubble-outline" class="error-icon"></ion-icon>
            <h4>Gagal Memuat Komentar</h4>
            <p>{{ commentsError }}</p>
            <ion-button size="small" (click)="loadCommentsFromFirestore()">
              Coba Lagi
            </ion-button>
          </div>
        </div>

        <!-- Comments List - BAGIAN UTAMA UNTUK MENAMPILKAN KOMENTAR -->
        <div class="comments-list" *ngIf="comments && comments.length > 0 && !isLoadingComments">
          <!-- Iterasi semua komentar -->
          <div class="comment-card" 
               *ngFor="let comment of comments; trackBy: trackByCommentId; index as i"
               [@slideIn]="'in'">
            
            <!-- Header komentar dengan info author -->
            <div class="comment-header">
              <div class="comment-author-info">
                <div class="comment-author-avatar-container">
                  <ion-icon name="person-circle" class="comment-author-avatar-icon"></ion-icon>
                </div>
                <div class="comment-author-details">
                  <div class="comment-author-name">{{ comment.author || 'Anonymous' }}</div>
                  <div class="comment-date">{{ comment.createdAt | date:'short' }}</div>
                </div>
              </div>

              <!-- Badge untuk dummy comments (untuk testing) -->
              <div class="comment-badge" *ngIf="comment.id && comment.id.includes('dummy')">
                <ion-badge color="warning" size="small">TEST</ion-badge>
              </div>
            </div>
            
            <!-- Konten komentar -->
            <div class="comment-content">
              <p>{{ comment.content }}</p>
            </div>
            
            <!-- Footer komentar dengan stats dan actions -->
            <div class="comment-footer">
              <div class="comment-stats">
                <div class="stat-item likes" [class.liked]="comment.userLiked">
                  <ion-icon name="heart"></ion-icon>
                  <span>{{ comment.likesCount || 0 }}</span>
                </div>
              </div>
              <ion-button 
                fill="clear" 
                size="small"
                class="comment-like-button"
                [class.liked]="comment.userLiked"
                (click)="toggleCommentLike(comment)">
                {{ comment.userLiked ? 'Disukai' : 'Suka' }}
              </ion-button>
            </div>
          </div>

          <!-- Message jika ada komentar yang dimuat -->
          <div class="comments-summary" *ngIf="comments.length > 0">
            <ion-text color="medium">
              <p><small>{{ comments.length }} komentar dimuat</small></p>
            </ion-text>
          </div>
        </div>

        <!-- No Comments State - tampil jika benar-benar kosong -->
        <div class="no-comments" *ngIf="(!comments || comments.length === 0) && !isLoadingComments && !commentsError">
          <ion-icon name="chatbubble-outline" class="no-comments-icon"></ion-icon>
          <h4>Belum ada komentar</h4>
          <p>Jadilah yang pertama memberikan komentar pada post ini!</p>
          
          <!-- Debug info untuk development -->
          <div class="debug-info" style="margin-top: 16px; padding: 12px; background: #f0f0f0; border-radius: 8px; font-size: 0.8rem;">
            <p><strong>Debug Info:</strong></p>
            <p>Post ID: {{ postId }}</p>
            <p>Comments Array: {{ comments ? comments.length : 'null' }}</p>
            <p>Is Loading: {{ isLoadingComments }}</p>
            <p>Has Error: {{ commentsError ? 'Yes' : 'No' }}</p>
          </div>
          
          <!-- Button untuk load test comments -->
          <ion-button 
            expand="block"
            fill="outline" 
            color="warning"
            (click)="loadDummyComments()"
            style="margin-top: 16px;">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Load Test Comments
          </ion-button>
          
          <!-- Button untuk reload dari Firestore -->
          <ion-button 
            expand="block"
            fill="solid" 
            color="primary"
            (click)="reloadComments()"
            [disabled]="isLoadingComments"
            style="margin-top: 8px;">
            <ion-icon name="reload" slot="start" *ngIf="!isLoadingComments"></ion-icon>
            <ion-spinner *ngIf="isLoadingComments" slot="start"></ion-spinner>
            {{ isLoadingComments ? 'Loading...' : 'Reload dari Firestore' }}
          </ion-button>
        </div>
      </div>

      <!-- Comment Form -->
      <div class="comment-form">
        <div class="form-header">
          <h4>Tulis Komentar</h4>
          <ion-text color="medium" *ngIf="!isLoggedIn">
            <p><small>Silakan login untuk menulis komentar</small></p>
          </ion-text>
        </div>
        
        <div class="form-content">
          <ion-item class="comment-input-item">
            <ion-textarea 
              [(ngModel)]="newComment"
              placeholder="Tulis komentar Anda di sini..."
              rows="4"
              class="comment-textarea"
              maxlength="500"
              [disabled]="!isLoggedIn">
            </ion-textarea>
          </ion-item>
          
          <!-- Character counter -->
          <div class="character-counter" *ngIf="newComment">
            <ion-text color="medium">
              <small>{{ newComment.length }}/500 karakter</small>
            </ion-text>
          </div>
          
          <ion-button 
            expand="block"
            class="submit-button"
            [disabled]="isSubmitting || !newComment?.trim() || !isLoggedIn"
            (click)="submitComment()">
            <ion-icon name="send" slot="start" *ngIf="!isSubmitting"></ion-icon>
            <ion-spinner name="crescent" slot="start" *ngIf="isSubmitting"></ion-spinner>
            {{ isSubmitting ? 'Mengirim...' : (isLoggedIn ? 'Kirim Komentar' : 'Login untuk Komentar') }}
          </ion-button>
          
          <!-- Login prompt button -->
          <ion-button 
            expand="block"
            fill="outline"
            class="login-button"
            *ngIf="!isLoggedIn"
            (click)="goToLogin()">
            <ion-icon name="log-in" slot="start"></ion-icon>
            Login Sekarang
          </ion-button>
        </div>
      </div>

      <!-- Manual Refresh Button untuk Development -->
      <div class="dev-actions" style="margin-top: 20px; text-align: center;">
        <ion-button 
          fill="outline" 
          size="small"
          (click)="loadCommentsFromFirestore()">
          <ion-icon name="refresh" slot="start"></ion-icon>
          Reload Comments
        </ion-button>
      </div>

    </div>

  </div>
</ion-content>